<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>3-7 ìš´ë™ íƒ€ì´ë¨¸ (iOS í˜¸í™˜ ì™„ì „íŒ)</title>
<style>
  body { font-family: Arial; text-align: center; margin-top: 4px; }
  #status { font-size: 80px; margin: 15px; }
  #timerDisplay { 
    font-size: 124px; 
    margin: 40px 0;  
    color: red; 
    font-weight: bold; 
    display: block;
  }
  .btn-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  button { 
    font-size: 35px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>3-7 ìš´ë™ íƒ€ì´ë¨¸</h1>
<div id="status">ëŒ€ê¸° ì¤‘</div>
<div id="timerDisplay">00:00</div>

<div class="btn-container">
  <button id="btnStart">ì‹œì‘</button>
  <button id="btnRest">íœ´ì‹</button>
  <button id="btnEndSet">ì„¸íŠ¸ ì¢…ë£Œ</button>
  <button id="btnStop">ì¢…ë£Œ</button>
</div>

<script>
let restClickCount = 0;
let timer;
let countdownInterval;
let audioUnlocked = false;

const nativeCountMap = {
  "3": "ì„¸",
  "4": "ë„¤",
  "5": "ë‹¤ì„¯",
  "6": "ì—¬ì„¯",
  "7": "ì¼ê³±",
};


// iOS Safari ì˜¤ë””ì˜¤ ê¶Œí•œ í™•ë³´ í•¨ìˆ˜ (ë¹ˆ ìŒì„± ì¬ìƒ)
function unlockAudio() {
  if (!audioUnlocked) {
    const utter = new SpeechSynthesisUtterance(" ");
    utter.lang = 'ko-KR';
    speechSynthesis.speak(utter);
    audioUnlocked = true;
    console.log("ğŸ”“ iOS ì˜¤ë””ì˜¤ ê¶Œí•œ í™•ë³´ë¨");
  }
}

// ìŒì„± ì•ˆë‚´ í•¨ìˆ˜
function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ko-KR';
  speechSynthesis.speak(utter);
}

// íƒ€ì´ë¨¸ ì´ˆê¸°í™”
function clearTimer() {
  if (timer) clearTimeout(timer);
  if (countdownInterval) clearInterval(countdownInterval);
}

// ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateDisplay(sec) {
  let min = Math.floor(sec / 60);
  let s = sec % 60;
  document.getElementById("timerDisplay").textContent =
    `${min}:${s < 10 ? '0' : ''}${s}`;
}

// ìƒíƒœ í‘œì‹œ + ìŒì„± ì¬ìƒ
function playSound(text) {
  document.getElementById("status").textContent = text;
  speak(text);
  console.log("ğŸ”Š " + text);
}

// ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
function startCountdown(seconds, message) {
  let timeLeft = seconds;
  updateDisplay(timeLeft);

  countdownInterval = setInterval(() => {
    timeLeft--;
    updateDisplay(timeLeft);

    if (timeLeft <= 3 && timeLeft > 0) {
      speak(timeLeft.toString());  // 3,2,1 ìŒì„± ì•ˆë‚´
    }

    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
    }
  }, 1000);

  timer = setTimeout(() => {
    playSound(message);
  }, seconds * 1000);
}

// ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
function startSequence() {
  clearTimer();
  restClickCount = 0;
  startNumber = 3
  startCountdown(5, `${nativeCountMap[startNumber]}ë²ˆ ì‹œì‘`);
  document.getElementById("status").textContent = `${nativeCountMap[startNumber]}ë²ˆ ì‹œì‘`;
}

// íœ´ì‹ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
function restButton() {
  clearTimer();
  restClickCount++;
  let startNumber = restClickCount + 3;
  if (restClickCount <= 4) {
    startCountdown(15, `${nativeCountMap[startNumber]}ë²ˆ ì‹œì‘`);
    document.getElementById("status").textContent = `${nativeCountMap[startNumber]}ë²ˆ ì‹œì‘`;
  } else {
    document.getElementById("status").textContent = "íœ´ì‹ ë²„íŠ¼ì€ ë„¤ë²ˆê¹Œì§€ë§Œ ìœ íš¨";
    document.getElementById("timerDisplay").textContent = "00:00";
  }
}

// ì„¸íŠ¸ ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
function endSet() {
  clearTimer();
  startCountdown(180, "ë‘ë²ˆì§¸ ë¼ìš´ë“œ ì‹œì‘");
  document.getElementById("status").textContent = "ë‘ë²ˆì§¸ ë¼ìš´ë“œ ì‹œì‘";
}

// ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
function stopTimer() {
  clearTimer();
  restClickCount = 0;
  document.getElementById("status").textContent = "ëŒ€ê¸° ì¤‘";
  document.getElementById("timerDisplay").textContent = "00:00";
}

// ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬: ì˜¤ë””ì˜¤ ê¶Œí•œ í™•ë³´ í›„ í•¨ìˆ˜ ì‹¤í–‰
function handleButtonClick(action) {
  unlockAudio();
  action();
}

// ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
document.getElementById("btnStart").addEventListener("click", () => handleButtonClick(startSequence));
document.getElementById("btnRest").addEventListener("click", () => handleButtonClick(restButton));
document.getElementById("btnEndSet").addEventListener("click", () => handleButtonClick(endSet));
document.getElementById("btnStop").addEventListener("click", () => handleButtonClick(stopTimer));
</script>

</body>
</html>